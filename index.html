<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Нейросетевая Леди Вики</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background: #1a1a1a;
            color: #e0e0e0;
            font-family: 'Arial', sans-serif;
        }
        
        #graph-container {
            position: absolute;
            width: 100%;
            height: 100%;
        }
        
        .node {
            position: absolute;
            width: 200px;
            padding: 15px;
            border-radius: 10px;
            background: #2d2d2d;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            transform: translate(-50%, -50%);
            transition: all 0.3s ease;
            cursor: pointer;
            z-index: 10;
        }
        
        .node:hover {
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.4);
            transform: translate(-50%, -50%) scale(1.05);
            z-index: 100;
        }
        
        .node.active {
            background: #3a3a5a;
            box-shadow: 0 0 20px rgba(100, 100, 255, 0.5);
        }
        
        .node-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #a0a0ff;
            font-size: 18px;
        }
        
        .node-content {
            font-size: 14px;
            line-height: 1.4;
        }
        
        .node-link {
            color: #80c0ff;
            text-decoration: underline;
            cursor: pointer;
        }
        
        .node-link:hover {
            color: #c0e0ff;
        }
        
        .link {
            position: absolute;
            height: 2px;
            background: rgba(100, 100, 255, 0.3);
            transform-origin: 0 0;
            z-index: 1;
        }
        
        #search {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
            padding: 10px;
            border-radius: 5px;
            border: none;
            background: rgba(45, 45, 45, 0.9);
            color: white;
            width: 300px;
        }
        
        #controls {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            gap: 10px;
        }
        
        button {
            padding: 8px 15px;
            border-radius: 5px;
            border: none;
            background: #3a3a5a;
            color: white;
            cursor: pointer;
        }
        
        button:hover {
            background: #4a4a6a;
        }
    </style>
</head>
<body>
    <input type="text" id="search" placeholder="Поиск заметок...">
    <div id="graph-container"></div>
    <div id="controls">
        <button id="center-view">Центрировать</button>
        <button id="add-note">Добавить заметку</button>
    </div>

    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script>
        // Инициализация данных
        let notes = {
            "welcome": {
                id: "welcome",
                title: "Добро пожаловать",
                content: "Это ваша нейросетевая лента заметок. Нажимайте на ссылки [[как в Obsidian]] для навигации.",
                x: 0,
                y: 0,
                links: ["obsidian", "neural-network"]
            },
            "obsidian": {
                id: "obsidian",
                title: "Obsidian",
                content: "Obsidian - это инструмент для работы с заметками, основанный на локальных Markdown-файлах. Подробнее на [[официальном сайте]].",
                x: -200,
                y: -150,
                links: ["welcome", "official-site"]
            },
            "neural-network": {
                id: "neural-network",
                title: "Нейронные сети",
                content: "Нейронные сети - это вычислительные системы, вдохновленные биологическими нейронными сетями. Читайте про [[глубокое обучение]].",
                x: 200,
                y: -150,
                links: ["welcome", "deep-learning"]
            },
            "official-site": {
                id: "official-site",
                title: "Официальный сайт Obsidian",
                content: "Официальный сайт: <a href='https://obsidian.md' target='_blank'>https://obsidian.md</a>",
                x: -300,
                y: -300,
                links: ["obsidian"]
            },
            "deep-learning": {
                id: "deep-learning",
                title: "Глубокое обучение",
                content: "Глубокое обучение - это подраздел машинного обучения, использующий многослойные нейронные сети. Связано с [[искусственным интеллектом]].",
                x: 300,
                y: -300,
                links: ["neural-network", "ai"]
            },
            "ai": {
                id: "ai",
                title: "Искусственный интеллект",
                content: "ИИ - это способность машин выполнять задачи, требующие человеческого интеллекта. Вернитесь к [[нейронные сети]] или [[добро пожаловать]].",
                x: 400,
                y: -450,
                links: ["deep-learning", "welcome"]
            }
        };

        // Инициализация графа
        const container = document.getElementById('graph-container');
        const width = window.innerWidth;
        const height = window.innerHeight;
        
        let activeNode = null;
        let nodes = [];
        let links = [];
        
        // Создаем узлы и связи
        function renderGraph() {
            // Очищаем контейнер
            container.innerHTML = '';
            
            // Создаем узлы
            Object.values(notes).forEach(note => {
                const node = document.createElement('div');
                node.className = 'node';
                node.id = `node-${note.id}`;
                node.style.left = `${width/2 + note.x}px`;
                node.style.top = `${height/2 + note.y}px`;
                
                // Обрабатываем ссылки в формате [[note-id]]
                let content = note.content;
                content = content.replace(/\[\[(.*?)\]\]/g, (match, noteId) => {
                    return `<span class="node-link" data-link="${noteId.toLowerCase()}">${noteId}</span>`;
                });
                
                node.innerHTML = `
                    <div class="node-title">${note.title}</div>
                    <div class="node-content">${content}</div>
                `;
                
                container.appendChild(node);
                
                // Добавляем обработчики событий
                node.addEventListener('click', (e) => {
                    if (e.target.classList.contains('node-link')) {
                        const linkId = e.target.getAttribute('data-link');
                        navigateTo(linkId);
                    } else {
                        setActiveNode(note.id);
                    }
                });
                
                nodes.push({
                    id: note.id,
                    element: node,
                    x: width/2 + note.x,
                    y: height/2 + note.y
                });
            });
            
            // Создаем связи
            Object.values(notes).forEach(note => {
                note.links.forEach(linkId => {
                    if (notes[linkId]) {
                        const source = nodes.find(n => n.id === note.id);
                        const target = nodes.find(n => n.id === linkId);
                        
                        if (source && target) {
                            const link = document.createElement('div');
                            link.className = 'link';
                            
                            // Рассчитываем позицию и длину линии
                            const dx = target.x - source.x;
                            const dy = target.y - source.y;
                            const length = Math.sqrt(dx*dx + dy*dy);
                            const angle = Math.atan2(dy, dx) * 180 / Math.PI;
                            
                            link.style.width = `${length}px`;
                            link.style.left = `${source.x}px`;
                            link.style.top = `${source.y}px`;
                            link.style.transform = `rotate(${angle}deg)`;
                            
                            container.appendChild(link);
                            links.push(link);
                        }
                    }
                });
            });
            
            // Активируем первый узел
            if (!activeNode && nodes.length > 0) {
                setActiveNode(nodes[0].id);
            }
        }
        
        // Установка активного узла
        function setActiveNode(nodeId) {
            // Деактивируем текущий активный узел
            if (activeNode) {
                const prevNode = document.getElementById(`node-${activeNode}`);
                if (prevNode) prevNode.classList.remove('active');
            }
            
            // Активируем новый узел
            activeNode = nodeId;
            const currentNode = document.getElementById(`node-${activeNode}`);
            if (currentNode) currentNode.classList.add('active');
            
            // Центрируем вид на активном узле
            centerView();
        }
        
        // Навигация к узлу
        function navigateTo(nodeId) {
            if (notes[nodeId]) {
                setActiveNode(nodeId);
            } else {
                alert(`Заметка "${nodeId}" не найдена!`);
            }
        }
        
        // Центрирование вида на активном узле
        function centerView() {
            if (!activeNode) return;
            
            const note = notes[activeNode];
            if (!note) return;
            
            // Смещаем все узлы так, чтобы активный был в центре
            const offsetX = -note.x;
            const offsetY = -note.y;
            
            Object.values(notes).forEach(n => {
                n.x += offsetX;
                n.y += offsetY;
            });
            
            renderGraph();
        }
        
        // Добавление новой заметки
        function addNewNote() {
            const title = prompt("Введите заголовок новой заметки:");
            if (!title) return;
            
            const content = prompt("Введите содержание заметки (используйте [[ссылки]] для связей):");
            
            // Генерируем ID из заголовка
            const id = title.toLowerCase().replace(/\s+/g, '-');
            
            if (notes[id]) {
                alert("Заметка с таким ID уже существует!");
                return;
            }
            
            // Позиционируем новую заметку рядом с активной
            let x = 0, y = 0;
            if (activeNode && notes[activeNode]) {
                x = notes[activeNode].x + (Math.random() * 200 - 100);
                y = notes[activeNode].y + (Math.random() * 200 - 100);
            }
            
            // Добавляем заметку
            notes[id] = {
                id,
                title,
                content: content || "",
                x,
                y,
                links: []
            };
            
            // Если есть активная заметка, создаем связь
            if (activeNode) {
                notes[activeNode].links.push(id);
                notes[id].links.push(activeNode);
            }
            
            renderGraph();
            setActiveNode(id);
        }
        
        // Поиск заметок
        function setupSearch() {
            const searchInput = document.getElementById('search');
            searchInput.addEventListener('input', (e) => {
                const query = e.target.value.toLowerCase();
                
                if (!query) {
                    Object.values(notes).forEach(note => {
                        const node = document.getElementById(`node-${note.id}`);
                        if (node) node.style.display = 'block';
                    });
                    return;
                }
                
                Object.values(notes).forEach(note => {
                    const node = document.getElementById(`node-${note.id}`);
                    if (node) {
                        const matches = note.title.toLowerCase().includes(query) || 
                                       note.content.toLowerCase().includes(query);
                        node.style.display = matches ? 'block' : 'none';
                    }
                });
            });
        }
        
        // Инициализация
        function init() {
            renderGraph();
            setupSearch();
            
            // Кнопка центрирования
            document.getElementById('center-view').addEventListener('click', centerView);
            
            // Кнопка добавления заметки
            document.getElementById('add-note').addEventListener('click', addNewNote);
            
            // Добавляем возможность перемещения узлов
            let draggedNode = null;
            let startX, startY, startNoteX, startNoteY;
            
            document.addEventListener('mousedown', (e) => {
                if (e.target.classList.contains('node') && !e.target.classList.contains('node-link')) {
                    draggedNode = e.target;
                    startX = e.clientX;
                    startY = e.clientY;
                    
                    const nodeId = draggedNode.id.replace('node-', '');
                    const note = notes[nodeId];
                    if (note) {
                        startNoteX = note.x;
                        startNoteY = note.y;
                    }
                }
            });
            
            document.addEventListener('mousemove', (e) => {
                if (draggedNode) {
                    const dx = e.clientX - startX;
                    const dy = e.clientY - startY;
                    
                    const nodeId = draggedNode.id.replace('node-', '');
                    const note = notes[nodeId];
                    if (note) {
                        note.x = startNoteX + dx;
                        note.y = startNoteY + dy;
                        renderGraph();
                    }
                }
            });
            
            document.addEventListener('mouseup', () => {
                draggedNode = null;
            });
        }
        
        // Запуск приложения
        window.addEventListener('load', init);
    </script>
</body>
</html>
